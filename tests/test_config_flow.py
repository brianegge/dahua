"""Tests for the Dahua config flow."""

from unittest.mock import patch

import pytest
from homeassistant import config_entries, data_entry_flow
from homeassistant.core import HomeAssistant
from homeassistant.loader import async_get_integration
from pytest_homeassistant_custom_component.common import MockConfigEntry

from custom_components.dahua.const import (
    CONF_ADDRESS,
    CONF_CHANNEL,
    CONF_EVENTS,
    CONF_NAME,
    CONF_PASSWORD,
    CONF_PORT,
    CONF_RTSP_PORT,
    CONF_USERNAME,
    DOMAIN,
)

MOCK_USER_INPUT = {
    CONF_USERNAME: "admin",
    CONF_PASSWORD: "password123",
    CONF_ADDRESS: "192.168.1.100",
    CONF_PORT: "80",
    CONF_RTSP_PORT: "554",
    CONF_CHANNEL: 0,
    CONF_EVENTS: ["VideoMotion", "CrossLineDetection"],
}

MOCK_DEVICE_DATA = {
    "name": "TestCamera",
    "serialNumber": "ABC123456",
}


@pytest.fixture(autouse=True)
async def setup_integration(hass: HomeAssistant):
    """Ensure the dahua integration is loaded before each test."""
    await async_get_integration(hass, DOMAIN)


async def test_user_flow_success(hass: HomeAssistant):
    """Test a successful config flow from the user step through the name step."""
    with patch(
        "custom_components.dahua.config_flow.DahuaFlowHandler._test_credentials",
        return_value=MOCK_DEVICE_DATA,
    ):
        # Step 1: show user form
        result = await hass.config_entries.flow.async_init(
            DOMAIN, context={"source": config_entries.SOURCE_USER}
        )
        assert result["type"] == data_entry_flow.FlowResultType.FORM
        assert result["step_id"] == "user"

        # Step 2: submit credentials
        result = await hass.config_entries.flow.async_configure(
            result["flow_id"],
            user_input=MOCK_USER_INPUT,
        )
        assert result["type"] == data_entry_flow.FlowResultType.FORM
        assert result["step_id"] == "name"

        # Step 3: submit name
        result = await hass.config_entries.flow.async_configure(
            result["flow_id"],
            user_input={CONF_NAME: "Front Porch"},
        )
        assert result["type"] == data_entry_flow.FlowResultType.CREATE_ENTRY
        assert result["title"] == "Front Porch"
        assert result["data"][CONF_USERNAME] == "admin"
        assert result["data"][CONF_ADDRESS] == "192.168.1.100"


async def test_user_flow_invalid_credentials(hass: HomeAssistant):
    """Test config flow with invalid credentials shows an error."""
    with patch(
        "custom_components.dahua.config_flow.DahuaFlowHandler._test_credentials",
        return_value=None,
    ):
        result = await hass.config_entries.flow.async_init(
            DOMAIN, context={"source": config_entries.SOURCE_USER}
        )
        result = await hass.config_entries.flow.async_configure(
            result["flow_id"],
            user_input=MOCK_USER_INPUT,
        )
        assert result["type"] == data_entry_flow.FlowResultType.FORM
        assert result["step_id"] == "user"
        assert result["errors"]["base"] == "auth"


async def test_user_flow_duplicate_device(hass: HomeAssistant):
    """Test config flow aborts when the device is already configured."""
    await async_get_integration(hass, DOMAIN)

    entry = MockConfigEntry(
        domain=DOMAIN,
        data=MOCK_USER_INPUT,
        title="Existing Camera",
        unique_id="ABC123456",
    )
    entry.add_to_hass(hass)

    with patch(
        "custom_components.dahua.config_flow.DahuaFlowHandler._test_credentials",
        return_value=MOCK_DEVICE_DATA,
    ):
        result = await hass.config_entries.flow.async_init(
            DOMAIN, context={"source": config_entries.SOURCE_USER}
        )
        result = await hass.config_entries.flow.async_configure(
            result["flow_id"],
            user_input=MOCK_USER_INPUT,
        )
        assert result["type"] == data_entry_flow.FlowResultType.ABORT
        assert result["reason"] == "already_configured"


async def test_options_flow(hass: HomeAssistant):
    """Test the options flow allows toggling platforms."""
    entry = MockConfigEntry(
        domain=DOMAIN,
        data=MOCK_USER_INPUT,
        title="Test Camera",
        unique_id="ABC123456",
    )
    entry.add_to_hass(hass)

    result = await hass.config_entries.options.async_init(entry.entry_id)
    assert result["type"] == data_entry_flow.FlowResultType.FORM
    assert result["step_id"] == "user"

    result = await hass.config_entries.options.async_configure(
        result["flow_id"],
        user_input={
            "binary_sensor": True,
            "camera": True,
            "light": False,
            "select": True,
            "switch": True,
        },
    )
    assert result["type"] == data_entry_flow.FlowResultType.CREATE_ENTRY
    assert result["data"]["light"] is False
    assert result["data"]["camera"] is True
